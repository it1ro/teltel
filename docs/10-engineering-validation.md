# Engineering Validation

Этот документ описывает сценарии инженерного тестирования teltel
для проверки поведения системы под нагрузкой, деградации и отказов.

Engineering Validation — это **валидационная фаза**, не добавляющая
нового функционального кода. Она проверяет соответствие реализации
архитектурным принципам и ожидаемому поведению.

---

## Цели валидации

1. Подтвердить, что система деградирует, а не ломается
2. Проверить изоляцию компонентов
3. Зафиксировать поведение под нагрузкой
4. Валидировать работу backpressure механизмов
5. Убедиться в отсутствии каскадных отказов

---

## Сценарии нагрузки

### 1. Высокая частота событий

**Сценарий:**
- Источник отправляет события с частотой 10,000+ событий/сек
- События поступают стабильным потоком
- Размер payload: ~500 байт на событие

**Ожидаемое поведение:**
- Ingest принимает события без блокировки источника
- EventBus маршрутизирует события подписчикам
- Live Buffer заполняется до capacity, затем перезаписывает старые события
- WebSocket клиенты получают события с задержкой (drop_old policy)
- Система не падает, не теряет память

**Метрики:**
- Throughput ingest (событий/сек)
- Latency обработки события
- Количество отброшенных событий по подписчикам
- Использование памяти

**Критерии успеха:**
- Система стабильна в течение 1+ часа
- Нет утечек памяти
- Источник не блокируется
- Подписчики изолированы друг от друга

---

### 2. Множественные одновременные run'ы

**Сценарий:**
- 10+ одновременных run'ов
- Каждый run отправляет 1,000 событий/сек
- Разные sourceId (flight-engine, drive-engine)

**Ожидаемое поведение:**
- Каждый run имеет свой Live Buffer
- EventBus корректно фильтрует события по runId
- WebSocket клиенты могут подписаться на конкретный run
- Ограничение maxRuns работает (если задано)

**Метрики:**
- Количество активных run'ов
- Использование памяти на run
- Latency фильтрации в EventBus

**Критерии успеха:**
- Все run'ы обрабатываются независимо
- Нет взаимного влияния между run'ами
- Система стабильна при максимальном количестве run'ов

---

### 3. Длительные сессии

**Сценарий:**
- Один run работает 4+ часа
- Частота событий: 5,000 событий/сек
- Общий объём: 72+ миллиона событий

**Ожидаемое поведение:**
- Live Buffer ограничивает память (ring buffer)
- Старые события перезаписываются
- Система не накапливает память
- WebSocket соединения стабильны

**Метрики:**
- Использование памяти (должно быть стабильным)
- Количество событий в buffer (не должно расти)
- Latency обработки (не должна деградировать)

**Критерии успеха:**
- Память стабильна в течение всей сессии
- Нет утечек памяти
- Система остаётся отзывчивой

---

### 4. Пиковые нагрузки (burst)

**Сценарий:**
- Нормальная нагрузка: 1,000 событий/сек
- Периодические всплески: 50,000 событий/сек на 10 секунд
- Интервал между всплесками: 1 минута

**Ожидаемое поведение:**
- Система обрабатывает всплески без падения
- События отбрасываются согласно backpressure policy
- После всплеска система возвращается к нормальной работе
- Нет накопления очередей

**Метрики:**
- Пиковая throughput
- Количество отброшенных событий во время всплеска
- Время восстановления после всплеска

**Критерии успеха:**
- Система переживает всплески без падения
- После всплеска система стабильна
- Подписчики изолированы (медленный не влияет на быстрый)

---

## Сценарии деградации

### 1. Перегрузка ingest

**Сценарий:**
- Источник отправляет события быстрее, чем ingest может обработать
- Частота: 20,000+ событий/сек
- Ingest не успевает парсить и публиковать

**Ожидаемое поведение:**
- Ingest принимает события best-effort
- Часть событий может быть отброшена на уровне HTTP
- Источник не блокируется (HTTP connection не зависает)
- Обработанные события публикуются в EventBus

**Метрики:**
- Количество принятых vs обработанных событий
- Latency обработки в ingest
- Количество ошибок парсинга

**Критерии успеха:**
- Источник не блокируется
- Система продолжает работать
- Обработанные события корректны

---

### 2. Медленный подписчик EventBus

**Сценарий:**
- Один подписчик читает события медленно (100 мс на событие)
- Другие подписчики читают нормально
- EventBus получает 5,000 событий/сек

**Ожидаемое поведение:**
- Медленный подписчик изолирован
- Его очередь заполняется согласно policy
- Другие подписчики не затрагиваются
- При policy=block медленный подписчик блокирует только свою очередь

**Метрики:**
- Размер очереди медленного подписчика
- Количество отброшенных событий
- Latency других подписчиков

**Критерии успеха:**
- Медленный подписчик не влияет на других
- Backpressure работает корректно
- Система остаётся стабильной

---

### 3. Переполнение Live Buffer

**Сценарий:**
- Run отправляет события быстрее, чем buffer может хранить
- Buffer capacity: 10,000 событий
- Частота: 20,000 событий/сек

**Ожидаемое поведение:**
- Buffer работает как ring buffer
- Старые события перезаписываются
- Buffer не растёт бесконечно
- Память ограничена capacity

**Метрики:**
- Размер buffer (должен быть ≤ capacity)
- Количество перезаписанных событий
- Использование памяти на run

**Критерии успеха:**
- Buffer не превышает capacity
- Память стабильна
- Новые события доступны

---

### 4. Перегрузка WebSocket соединений

**Сценарий:**
- 10+ WebSocket клиентов подключены одновременно
- Каждый подписан на разные run'ы
- Каждый run отправляет 5,000 событий/сек

**Ожидаемое поведение:**
- Каждый клиент имеет свою подписку (policy=drop_old)
- Медленный клиент не влияет на быстрых
- События отбрасываются согласно policy
- Соединения стабильны

**Метрики:**
- Latency отправки события клиенту
- Количество отброшенных событий на клиента
- Количество активных WebSocket соединений

**Критерии успеха:**
- Клиенты изолированы
- Медленный клиент не блокирует других
- Соединения не разрываются

---

## Сценарии отказов

### 1. Некорректные события

**Сценарий:**
- Смешанный поток: 90% валидных событий, 10% некорректных
- Некорректные события: невалидный JSON, отсутствующие поля, неверный формат
- Частота: 1,000 событий/сек

**Ожидаемое поведение:**
- Некорректные события отбрасываются
- Валидные события обрабатываются нормально
- Ingest не падает
- Ошибки логируются, но не блокируют обработку

**Метрики:**
- Количество отброшенных некорректных событий
- Количество обработанных валидных событий
- Количество ошибок парсинга

**Критерии успеха:**
- Система продолжает работать
- Валидные события не теряются
- Нет падений ingest

---

### 2. Внезапное отключение клиентов

**Сценарий:**
- 5 WebSocket клиентов подключены
- Клиенты внезапно отключаются (закрытие браузера, сетевой сбой)
- События продолжают поступать

**Ожидаемое поведение:**
- Подписки закрываются корректно
- EventBus освобождает ресурсы
- Другие клиенты не затрагиваются
- Нет утечек памяти или goroutine

**Метрики:**
- Количество активных подписок
- Использование памяти после отключений
- Количество goroutine (не должно расти)

**Критерии успеха:**
- Подписки закрываются полностью
- Нет утечек ресурсов
- Система стабильна

---

### 3. Перезапуск сервиса

**Сценарий:**
- Сервис работает, обрабатывает события
- Сервис перезапускается (graceful shutdown)
- События продолжают поступать во время перезапуска

**Ожидаемое поведение:**
- Graceful shutdown закрывает все подписки
- In-memory данные теряются (ожидаемо)
- После перезапуска система работает нормально
- Новые события обрабатываются

**Метрики:**
- Время graceful shutdown
- Количество потерянных событий
- Время восстановления после перезапуска

**Критерии успеха:**
- Graceful shutdown работает
- Нет зависших ресурсов
- Система восстанавливается быстро

---

### 4. Сетевые проблемы

**Сценарий:**
- WebSocket соединения установлены
- Временная потеря сети (5 секунд)
- События продолжают поступать

**Ожидаемое поведение:**
- WebSocket соединения обнаруживают разрыв
- Подписки закрываются
- После восстановления сети клиенты могут переподключиться
- Система продолжает работать

**Метрики:**
- Время обнаружения разрыва
- Количество переподключений
- Потеря событий во время разрыва

**Критерии успеха:**
- Разрывы обнаруживаются быстро
- Подписки закрываются корректно
- Переподключение работает

---

## Валидация поведения

### 1. Best-effort доставка

**Проверка:**
- Система не гарантирует доставку всех событий
- Потеря данных допустима и ожидаема
- Система предпочитает деградацию блокировке

**Критерии:**
- При перегрузке события отбрасываются
- Система не блокирует источники
- Подписчики получают события best-effort

---

### 2. Изоляция компонентов

**Проверка:**
- Компоненты изолированы друг от друга
- Проблема в одном компоненте не влияет на другие
- Backpressure изолирован по подписчикам

**Критерии:**
- Медленный подписчик не влияет на быстрых
- Перегрузка ingest не ломает EventBus
- Проблемы в UI не влияют на storage

---

### 3. Отсутствие каскадных отказов

**Проверка:**
- Отказ одного компонента не вызывает отказы других
- Система деградирует постепенно
- Критические пути защищены

**Критерии:**
- Перегрузка не вызывает падений
- Ошибки обрабатываются gracefully
- Система остаётся работоспособной

---

### 4. Работа backpressure

**Проверка:**
- Три политики работают корректно:
  - `block`: блокирует публикацию
  - `drop_new`: отбрасывает новые события
  - `drop_old`: перезаписывает старые события

**Критерии:**
- Политики применяются изолированно
- Метрики отброшенных событий корректны
- Система не блокируется при block policy

---

## Метрики и мониторинг

### Ключевые метрики

1. **Throughput**
   - Событий/сек на ingest
   - Событий/сек на EventBus
   - Событий/сек на подписчика

2. **Latency**
   - Время обработки события в ingest
   - Время доставки события подписчику
   - Latency WebSocket отправки

3. **Потери данных**
   - Количество отброшенных событий по подписчикам
   - Количество перезаписанных событий в buffer
   - Количество некорректных событий

4. **Ресурсы**
   - Использование памяти
   - Количество goroutine
   - Размеры очередей

---

## Критерии успеха валидации

1. **Стабильность**
   - Система работает стабильно под нагрузкой
   - Нет утечек памяти
   - Нет падений

2. **Деградация**
   - Система деградирует gracefully
   - Компоненты изолированы
   - Нет каскадных отказов

3. **Производительность**
   - Throughput соответствует ожиданиям
   - Latency приемлема
   - Ресурсы используются эффективно

4. **Соответствие принципам**
   - Best-effort доставка работает
   - Backpressure работает корректно
   - Изоляция компонентов подтверждена

---

## Связанные документы

- `docs/08-failure-modes.md` — описание failure modes
- `docs/09-roadmap.md` — roadmap с фазой Engineering Validation
- `docs/04-eventbus.md` — контракт EventBus
- `docs/05-ingest-and-storage.md` — ingest и storage pipeline
