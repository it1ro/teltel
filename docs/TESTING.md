# Тестирование

## Важно

⚠️ **Тесты запускаются ТОЛЬКО через Docker.**  
Локальный `go test` больше не является поддерживаемым способом запуска тестов.

Проект использует integration-тесты для фиксации контрактов компонентов.  
Все тесты выполняются в Docker-контейнере для обеспечения воспроизводимости и идентичности с CI.

---

## Запуск тестов

### Базовые команды

**Все тесты (автоматически поднимает ClickHouse и ждёт готовности):**
```bash
make test
```

**Быстрый запуск (предполагает, что ClickHouse уже запущен):**
```bash
make test-fast
```

**Только тесты storage:**
```bash
make test-storage
```

**Очистка test-контейнеров:**
```bash
make test-clean
```

### Запуск конкретных тестов

**Тесты конкретного компонента:**
```bash
docker-compose run --rm test go test ./internal/event -v
```

**С покрытием:**
```bash
docker-compose run --rm test go test ./internal/event -cover
```

**С дополнительными флагами:**
```bash
docker-compose run --rm test go test ./internal/storage -v -count=1
```

---

## Покрытие тестами

### Компоненты с тестами

#### `internal/event`
- **Тип тестов:** Integration-тесты
- **Проверяет:**
  - Валидацию Event Model
  - Парсинг NDJSON
  - Корректность структуры событий

#### `internal/eventbus`
- **Тип тестов:** Integration-тесты
- **Проверяет:**
  - Публикацию событий
  - Фильтрацию событий
  - Backpressure механизмы
  - Изоляцию подписчиков
  - Статистику работы EventBus

#### `internal/ingest`
- **Тип тестов:** Integration-тесты
- **Проверяет:**
  - HTTP контракт ingest endpoint
  - NDJSON обработку
  - Интеграцию с EventBus
  - WallTime семантику
  - Failure-cases (обработка ошибок)

#### `internal/storage`
- **Тип тестов:** Integration-тесты
- **Проверяет:**
  - Обновление метаданных из событий
  - Run lifecycle (start, end)
  - Вычисляемые поля
  - Интеграцию с ClickHouse
  - Failure-cases (обработка ошибок)

---

## Принципы тестирования

### Integration-тесты

Все тесты являются integration-тестами, которые:
- Проверяют только публичное поведение компонентов
- Не используют моки или рефлексию
- Выполняются в изолированном Docker-контейнере
- Используют реальный ClickHouse для storage-тестов

### Фиксация контрактов

Тесты служат для фиксации контрактов компонентов:
- HTTP API контракты
- Event Model контракты
- EventBus контракты
- Storage контракты

---

## Требования

### Обязательные требования

- **Docker** и **docker-compose** должны быть установлены
- Тесты автоматически поднимают ClickHouse через docker-compose
- Все тесты выполняются в изолированном контейнере

### Конфигурация

Тесты используют конфигурацию из `docker-compose.yml`:
- ClickHouse контейнер для storage-тестов
- Изолированная среда выполнения
- Автоматическая очистка после выполнения

---

## Инженерное тестирование

Для нагрузочного и инженерного тестирования см.:
- [ENGINEERING_VALIDATION_GUIDE.md](ENGINEERING_VALIDATION_GUIDE.md)
- [10-engineering-validation.md](10-engineering-validation.md)

Эти документы описывают:
- Нагрузочное тестирование
- Сценарии инженерного тестирования
- Проверку failure modes
- Тестирование под нагрузкой

---

## Примечания

- Тесты не требуют предварительной настройки окружения (кроме Docker)
- Все зависимости автоматически поднимаются через docker-compose
- Результаты тестов воспроизводимы благодаря изоляции в контейнерах
- Тесты проверяют реальное поведение системы, а не моки
