# Event Model

Этот документ описывает модель событий teltel.
Он определяет структуру, инварианты и правила формирования телеметрии.

Все источники телеметрии (Flight Engine и Drive Engine)
должны следовать этому контракту.

---

## Общие принципы

- одно событие = один факт
- события не содержат “человеческих” сообщений
- события сериализуются как NDJSON
- порядок событий best‑effort
- доставка не гарантируется

---

## Базовая структура события

Каждое событие имеет следующую структуру:

```json
{
  "v": 1,
  "runId": "string",
  "sourceId": "flight-engine | drive-engine",
  "channel": "string",
  "type": "string",

  "frameIndex": 1234,
  "simTime": 12.345,
  "wallTimeMs": 1730000000000,

  "tags": { "key": "value" },
  "payload": { }
}
```

---

## Поля события

### `v`
Версия схемы события.

- обязательное поле
- используется для эволюции формата
- v1 — текущая версия

---

### `runId`
Идентификатор запуска симуляции.

- один run = один запуск
- все события run’а имеют одинаковый `runId`
- генерируется движком или сервисом

---

### `sourceId`
Источник события.

Допустимые значения:
- `flight-engine`
- `drive-engine`

---

### `channel`
Логическая группа событий.

Примеры:
- `physics`
- `aero`
- `drivetrain`
- `input`
- `integrator`

Используется для фильтрации и подписок.

---

### `type`
Тип события.

- строка
- иерархическая нотация через `.`
- используется для фильтрации и анализа

Примеры:
- `run.start`
- `frame.start`
- `frame.end`
- `body.state`
- `aero.state`
- `wheel.force`

---

### `frameIndex`
Индекс кадра симуляции.

- целое число
- монотонно возрастает
- основная ось детерминированного анализа

---

### `simTime`
Симуляционное время в секундах.

- число с плавающей точкой
- монотонно возрастает
- вторичная ось анализа

---

### `wallTimeMs`
Время на хосте (epoch ms).

- необязательное поле
- используется для корреляции и отладки
- не используется для анализа симуляции

---

### `tags`
Набор произвольных тегов.

- ключ‑значение
- используются для фильтрации
- не должны дублировать payload

Примеры:
- `vehicle=car01`
- `aircraft=f16`
- `scene=freeflight`

---

### `payload`
Данные события.

- JSON‑объект
- содержит только структурированные данные
- не содержит текстовых сообщений

---

## Инварианты

- `frameIndex` и `simTime` обязательны для всех кадровых событий
- `payload` не должен изменять форму для одного `type`
- отсутствие события допустимо
- дублирование событий допустимо

---

## Базовые типы событий

### `run.start`
Начало run’а.

Payload:
- конфигурация
- версия движка
- seed

---

### `run.end`
Завершение run’а.

Payload:
- причина завершения
- итоговый статус

---

### `frame.start`
Начало кадра.

Payload:
- запрошенный dt

---

### `frame.end`
Завершение кадра.

Payload:
- использованный dt
- количество подшагов
- опциональные perf‑метрики

---

### `body.state`
Состояние основного тела.

Payload:
- `pos.{x,y,z}`
- `vel.{x,y,z}`
- `rot.{qx,qy,qz,qw}`
- `omega.{x,y,z}`

---

### `aero.state` (Flight Engine)
Аэродинамическое состояние.

Payload:
- `aoa`
- `beta`
- `q`
- `cl`
- `cd`
- `lift`
- `drag`

---

### `wheel.force` (Drive Engine)
Силы на колёсах.

Payload:
- `wheelId`
- `force.{x,y,z}`
- `slipRatio`
- `normalLoad`

---

## Эволюция схемы

- новые поля добавляются в payload
- существующие поля не удаляются
- изменение смысла поля требует новой версии `v`

---

## Связанные документы

- `docs/02-architecture.md`
- `docs/04-eventbus.md`
- `docs/05-ingest-and-storage.md`
