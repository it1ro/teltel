# Аудит Legacy UI v1

**Дата:** 2024-12-19  
**Этап:** Этап 1 — Аудит Legacy UI  
**Цель:** Полное понимание функциональности legacy UI и её использования

---

## 1. Функциональность Legacy UI (web/index.html + web/app.js)

### 1.1 Основные возможности

**Файлы:**
- `web/index.html` — главная страница Live UI
- `web/app.js` — логика подключения и отрисовки

**Технологии:**
- HTML + vanilla JavaScript
- Chart.js 4.4.0 (CDN)
- WebSocket подключение к `/ws` endpoint

### 1.2 Функциональность

#### 1.2.1 Отображение активных run'ов
- **Функция:** `loadRuns()`
- **API:** `GET /api/runs`
- **Описание:** Загружает список активных run'ов и отображает их в виде кликабельных карточек
- **Обновление:** Автоматическое обновление каждые 5 секунд
- **Отображение:** 
  - Формат: `{runId} ({sourceId || 'unknown'})`
  - Визуальное выделение активного run'а (синий фон)
  - Поддержка множественных run'ов одновременно

#### 1.2.2 Выбор и переключение между run'ами
- **Функция:** `selectRun(runId)`
- **Описание:** 
  - Позволяет выбрать активный run для визуализации
  - При выборе нового run'а:
    - Закрывает предыдущее WebSocket соединение
    - Очищает график
    - Обновляет UI (выделение активного run'а)
    - Открывает новое WebSocket соединение с подпиской на выбранный run

#### 1.2.3 WebSocket подключение
- **Функция:** `connectWebSocket(runId)`
- **Endpoint:** `ws://{host}/ws`
- **Протокол:**
  - При открытии соединения отправляет JSON: `{runId: string}`
  - Получает события в формате JSON
  - Обрабатывает события через `handleEvent()`
- **Статус подключения:**
  - Визуальный индикатор статуса (зелёный = подключено, красный = отключено)
  - Отображение текстового статуса ("Подключено", "Отключено", "Переподключение...", "Ошибка подключения")

#### 1.2.4 Визуализация данных в реальном времени
- **Библиотека:** Chart.js 4.4.0
- **Тип графика:** Line chart (линейный график)
- **Оси:**
  - X: `frameIndex` (индекс кадра)
  - Y: Значения из payload
- **Серии данных:**
  1. **frameIndex** (синяя линия) — отображает сам frameIndex как значение
  2. **body.state.pos.x** (зелёная линия) — извлекает значение из `payload.body.state.pos.x`
- **Обработка данных:**
  - Функция `handleEvent(event)`:
    - Парсит `event.payload` как JSON
    - Извлекает `body.state.pos.x` по жёстко заданному пути
    - Добавляет точки на график
    - Ограничивает количество точек (последние 1000 точек)
- **Обновление графика:**
  - Real-time обновление без анимации (`chart.update('none')`)
  - Автоматическое ограничение буфера (удаление старых точек)

#### 1.2.5 Ограничения и особенности
- **Жёстко заданные пути данных:**
  - Только `body.state.pos.x` извлекается из payload
  - Нет возможности настройки путей через UI
- **Ограниченное количество серий:**
  - Только 2 серии данных (frameIndex и pos.x)
  - Нет возможности добавления дополнительных серий
- **Нет интерактивности:**
  - Нет zoom/pan
  - Нет hover tooltips
  - Нет возможности выбора временного диапазона
- **Простая визуализация:**
  - Только линейные графики
  - Нет поддержки других типов графиков (scatter, histogram, etc.)

---

## 2. Функциональность Legacy Analysis UI (web/analysis.html + web/analysis.js)

### 2.1 Основные возможности

**Файлы:**
- `web/analysis.html` — страница анализа завершённых run'ов
- `web/analysis.js` — логика анализа

**Технологии:**
- HTML + vanilla JavaScript
- Chart.js 4.4.0 (CDN)
- REST API для работы с завершёнными run'ами

### 2.2 Функциональность

#### 2.2.1 Загрузка списка завершённых run'ов
- **Функция:** `loadRuns()`
- **API:** `GET /api/analysis/runs`
- **Query параметры:**
  - `sourceId` (опционально) — фильтр по source_id
  - `status` (опционально) — фильтр по статусу (completed, failed, cancelled)
  - `daysBack` (по умолчанию 30) — количество дней назад
- **Отображение:**
  - Список run'ов с метаданными:
    - `run_id`
    - `source_id`
    - `status`
    - `started_at` (форматированная дата)
  - Кликабельные карточки для выбора run'а
  - Визуальное выделение активного run'а

#### 2.2.2 Просмотр метаданных run'а
- **Функция:** `loadRunMetadata(runId)`
- **API:** `GET /api/analysis/run/{runId}`
- **Отображаемые метаданные:**
  - `run_id`
  - `source_id`
  - `status`
  - `started_at` (форматированная дата)
  - `ended_at` (форматированная дата)
  - `duration_seconds` (длительность в секундах)
  - `total_events` (общее количество событий)
  - `total_frames` (общее количество кадров)
  - `max_frame_index` (максимальный индекс кадра)
  - `engine_version`
  - `seed` (если есть)
  - `end_reason` (если есть)

#### 2.2.3 Визуализация временных рядов
- **Функция:** `loadSeries()`
- **API:** `GET /api/analysis/series`
- **Query параметры:**
  - `runId` (обязательно)
  - `eventType` (обязательно) — тип события (например, `body.state`)
  - `sourceId` (обязательно) — идентификатор источника
  - `jsonPath` (обязательно) — JSONPath к значению в payload (например, `pos.x`)
- **Функциональность:**
  - Загружает временной ряд для указанного run'а
  - Отображает график с данными
  - Показывает SQL запрос, который был выполнен (для копирования)
  - Кнопка копирования SQL в буфер обмена
- **Визуализация:**
  - Line chart (линейный график)
  - X: `frame_index`
  - Y: Значение из payload по указанному JSONPath
  - Одна серия данных

#### 2.2.4 Сравнение двух run'ов
- **Функция:** `loadCompare()`
- **API:** `GET /api/analysis/compare`
- **Query параметры:**
  - `runId1` (обязательно) — первый run
  - `runId2` (обязательно) — второй run
  - `eventType` (обязательно)
  - `sourceId` (обязательно)
  - `jsonPath` (обязательно)
- **Функциональность:**
  - Загружает данные для двух run'ов
  - Отображает оба run'а на одном графике (разные цвета)
  - Показывает SQL запрос для копирования
  - Визуализирует разницу между run'ами
- **Визуализация:**
  - Line chart с двумя сериями:
    - Синяя линия — первый run
    - Зелёная линия — второй run
  - X: `frame_index`
  - Y: Значения из обоих run'ов

#### 2.2.5 Отображение SQL запросов
- **Функция:** `copySql(elementId)`
- **Описание:**
  - Показывает SQL запрос, который был выполнен для получения данных
  - Кнопка копирования SQL в буфер обмена
  - Поддержка для временных рядов и сравнения run'ов
- **Формат SQL:**
  - Для временных рядов: `SELECT frame_index, sim_time, JSONExtractFloat(payload, '{jsonPath}') AS value FROM ...`
  - Для сравнения: `SELECT ... INNER JOIN ...` с вычислением разницы

#### 2.2.6 Парсинг JSONEachRow формата
- **Функция:** `parseJSONEachRow(text)`
- **Описание:**
  - Парсит ответы API в формате JSONEachRow (каждая строка — отдельный JSON объект)
  - Обрабатывает ошибки парсинга
  - Возвращает массив объектов

#### 2.2.7 Ограничения и особенности
- **Требует ручного ввода параметров:**
  - Пользователь должен вручную вводить `eventType`, `sourceId`, `jsonPath`
  - Нет автодополнения или выбора из списка
- **Один график за раз:**
  - Можно визуализировать только один временной ряд или одно сравнение
  - Нет возможности отображения нескольких графиков одновременно
- **Простая визуализация:**
  - Только линейные графики
  - Нет поддержки других типов графиков
- **Нет интерактивности:**
  - Нет zoom/pan
  - Нет hover tooltips
  - Нет возможности выбора временного диапазона

---

## 3. Сравнение с Live UI v2

### 3.1 Функциональность Legacy UI (index.html + app.js)

| Функция | Legacy UI | Live UI v2 | Статус |
|---------|-----------|------------|--------|
| Отображение активных run'ов | ✅ | ✅ (через run_list компонент) | ✅ Реализовано |
| Выбор run'а | ✅ | ✅ (через run_selector и selected_run state) | ✅ Реализовано |
| WebSocket подключение | ✅ | ✅ (через Data Layer) | ✅ Реализовано |
| Real-time визуализация | ✅ (Chart.js) | ✅ (Observable Plot) | ✅ Реализовано |
| Отображение frameIndex | ✅ | ✅ (через mappings.x) | ✅ Реализовано |
| Отображение body.state.pos.x | ✅ (жёстко задано) | ✅ (через JSONPath в mappings) | ✅ Реализовано |
| Ограничение буфера (1000 точек) | ✅ | ✅ (через window logic) | ✅ Реализовано |
| Статус подключения | ✅ | ✅ (через status_indicator) | ✅ Реализовано |
| Автообновление списка run'ов | ✅ (каждые 5 сек) | ✅ (через Data Layer) | ✅ Реализовано |
| Интерактивность (zoom/pan) | ❌ | ✅ (Stage 7) | ✅ Улучшено |
| Hover tooltips | ❌ | ✅ (Stage 7) | ✅ Улучшено |
| Множественные серии | ❌ (только 2) | ✅ (через series в ChartSpec) | ✅ Улучшено |
| Настройка путей данных | ❌ (жёстко задано) | ✅ (через JSONPath в mappings) | ✅ Улучшено |
| Другие типы графиков | ❌ (только line) | ✅ (time_series, scatter, histogram, event_timeline) | ✅ Улучшено |
| Декларативная конфигурация | ❌ | ✅ (через Layout и ChartSpec JSON) | ✅ Улучшено |

**Вывод:** Все функции Legacy UI реализованы в Live UI v2, причём с улучшениями (интерактивность, гибкость конфигурации, больше типов графиков).

### 3.2 Функциональность Legacy Analysis UI (analysis.html + analysis.js)

| Функция | Legacy Analysis UI | Live UI v2 | Статус |
|---------|-------------------|------------|--------|
| Загрузка завершённых run'ов | ✅ | ✅ (через RunList компонент + AnalysisClient) | ✅ Реализовано |
| Фильтрация run'ов (sourceId, status, daysBack) | ✅ | ✅ (через filters в RunList) | ✅ Реализовано |
| Просмотр метаданных run'а | ✅ | ✅ (отображается в RunList с showDetails) | ✅ Реализовано |
| Визуализация временных рядов | ✅ | ✅ (через historical data_source) | ✅ Реализовано |
| Сравнение двух run'ов | ✅ | ✅ (через run_comparison chart type) | ✅ Реализовано |
| Отображение SQL запросов | ✅ | ❌ | ❌ Отсутствует |
| Копирование SQL в буфер обмена | ✅ | ❌ | ❌ Отсутствует |
| Ручной ввод параметров (eventType, sourceId, jsonPath) | ✅ | ✅ (через ChartSpec filters) | ✅ Реализовано |
| Парсинг JSONEachRow | ✅ | ✅ (через AnalysisClient.parseJSONEachRow) | ✅ Реализовано |
| Интерактивность (zoom/pan) | ❌ | ✅ (Stage 7) | ✅ Улучшено |
| Hover tooltips | ❌ | ✅ (Stage 7) | ✅ Улучшено |
| Множественные графики | ❌ (один за раз) | ✅ (через grid layout) | ✅ Улучшено |

**Вывод:** 
- ✅ **Все критичные функции Analysis UI реализованы в Live UI v2:**
  - Загрузка завершённых run'ов через `RunList` компонент с фильтрацией по `status: ["completed"]`
  - Фильтрация по `sourceId`, `status`, `daysBack` через `filters` в `RunList`
  - Просмотр метаданных run'а отображается в `RunList` с `showDetails={true}`
  - Визуализация временных рядов через `historical` data_source в ChartSpec
  - Сравнение run'ов через `run_comparison` chart type
- ❌ **Отсутствует:** Отображение SQL запросов и копирование SQL в буфер обмена (некритичная функция)

---

## 4. Упоминания Legacy UI в проекте

### 4.1 Документация

#### 4.1.1 `docs/API.md`
- **Строки 12-15:** Секция "Legacy UI"
  - Описание: "Старый Live UI (графики реального времени)"
  - Endpoint: `GET /` или `GET /index.html`
  - Доступ: `http://localhost:8080` или `http://localhost:8081`
- **Строки 17-20:** Секция "Analysis UI"
  - Описание: "Интерфейс для анализа завершённых run'ов"
  - Endpoint: `GET /analysis.html`
  - Доступ: `http://localhost:8080/analysis.html` или `http://localhost:8081/analysis.html`

#### 4.1.2 `docs/USER_GUIDE.md`
- **Строка 413:** Упоминание "Legacy (встроенный)" режима
  - Описание: "статические файлы из `web/` директории (устаревший)"
- **Строка 468:** Секция "Legacy режим (встроенный, устаревший)"
- **Строка 887:** Упоминание Analysis UI (`analysis.html`)

#### 4.1.3 `DOCKER.md`
- **Нет явных упоминаний legacy UI** — документ описывает только Live UI v2

#### 4.1.4 `docs/LIVE_UI_V2_FREEZE.md`
- **Строка 63:** Упоминание Analysis UI как реализованного отдельно в `analysis.html`

#### 4.1.5 `docs/ENGINEERING_VALIDATION_GUIDE.md`
- **Строка 227:** Упоминание `http://localhost:8080/analysis.html`

#### 4.1.6 `docs/PHASE3_FREEZE.md`
- **Строка 84:** Упоминание отдельной страницы `/analysis.html`

### 4.2 Скрипты валидации

#### 4.2.1 `scripts/validate.sh`
- **Строки 96-106:** Проверка доступности legacy UI
  - Строка 96: Проверка `$BASE_URL/` (legacy Live UI)
  - Строка 102: Проверка `$BASE_URL/analysis.html` (legacy Analysis UI)

#### 4.2.2 `scripts/validate_cursor_workflow.sh`
- **Строка 75:** Упоминание `analysis.html` для ручной проверки

### 4.3 Backend код

#### 4.3.1 `cmd/teltel/main.go`
- **Строки 22-52:** Функция `findWebDir()` — поиск директории `web/`
- **Строки 147-156:** Обслуживание статических файлов из `web/`
  - Строка 149: Поиск директории `web/`
  - Строка 151: Предупреждение, если `web/` не найдена
  - Строка 153: Логирование пути к статическим файлам
  - Строка 154: `http.FileServer` для обслуживания `web/`
  - Строка 155: Маппинг `mux.Handle("/", fs)`
- **Строка 179:** Логирование "Web UI: http://localhost:%d"

### 4.4 Docker

#### 4.4.1 `Dockerfile`
- **Строка 28:** `COPY --from=builder /build/web /app/web` — копирование директории `web/` в образ

#### 4.4.2 `Makefile`
- **Строка 35:** Сообщение "Stack started. teltel: http://localhost:8081" (неявно указывает на legacy UI)

### 4.5 Другие файлы

#### 4.5.1 `ENGINEERING_AUDIT_REPORT.md`
- **Строки 134-144:** Упоминание `web/index.html` и несоответствие документации

#### 4.5.2 `STANDALONE_LIVE_UI_2_SERVICE_ROADMAP.md`
- **Строка 14:** Упоминание того, что backend отдаёт старый UI из `web/`
- **Строка 172:** План убрать отдачу статических файлов из `web/`
- **Строка 467:** Упоминание обновления `docs/USER_GUIDE.md` с тремя режимами запуска (включая legacy)

---

## 5. Сводная таблица функций

### 5.1 Legacy Live UI (index.html + app.js)

| Функция | Описание | Критичность | Статус в Live UI v2 |
|---------|----------|-------------|---------------------|
| Отображение активных run'ов | Список run'ов с автообновлением | Высокая | ✅ Реализовано |
| Выбор run'а | Переключение между run'ами | Высокая | ✅ Реализовано |
| WebSocket подключение | Real-time поток данных | Высокая | ✅ Реализовано |
| Real-time визуализация | Графики в реальном времени | Высокая | ✅ Реализовано |
| Статус подключения | Индикатор подключения | Средняя | ✅ Реализовано |
| Ограничение буфера | Последние 1000 точек | Низкая | ✅ Реализовано |

### 5.2 Legacy Analysis UI (analysis.html + analysis.js)

| Функция | Описание | Критичность | Статус в Live UI v2 |
|---------|----------|-------------|---------------------|
| Загрузка завершённых run'ов | Список завершённых run'ов | Высокая | ✅ Реализовано (RunList + AnalysisClient) |
| Фильтрация run'ов | По sourceId, status, daysBack | Средняя | ✅ Реализовано (filters в RunList) |
| Просмотр метаданных | Детальная информация о run'е | Средняя | ✅ Реализовано (showDetails в RunList) |
| Визуализация временных рядов | График для завершённого run'а | Высокая | ✅ Реализовано (historical data_source) |
| Сравнение run'ов | Сравнение двух run'ов | Средняя | ✅ Реализовано (run_comparison chart type) |
| Отображение SQL | Показ SQL запроса | Низкая | ❌ Отсутствует (некритично) |
| Копирование SQL | Копирование SQL в буфер | Низкая | ❌ Отсутствует (некритично) |

---

## 6. Выводы и рекомендации

### 6.1 Функциональность Legacy Live UI

✅ **Все функции Legacy Live UI реализованы в Live UI v2**

- Все базовые функции (отображение run'ов, выбор, WebSocket, визуализация) реализованы
- Live UI v2 предоставляет улучшенную функциональность (интерактивность, гибкость конфигурации, больше типов графиков)
- **Рекомендация:** Legacy Live UI можно безопасно удалить

### 6.2 Функциональность Legacy Analysis UI

✅ **Все критичные функции реализованы в Live UI v2**

- ✅ Загрузка завершённых run'ов реализована через `RunList` компонент с фильтром `status: ["completed"]`
- ✅ Фильтрация по `sourceId`, `status`, `daysBack` реализована через `filters` в `RunList`
- ✅ Просмотр метаданных run'а реализован через `showDetails={true}` в `RunList`
- ✅ Визуализация временных рядов и сравнение run'ов реализованы
- ❌ Отсутствует: отображение SQL запросов и копирование SQL в буфер обмена (некритичная функция)

**Рекомендации:**
1. ✅ **Подтверждено:** Все критичные функции Analysis UI реализованы в Live UI v2
2. **Оценка критичности отображения SQL:**
   - Функция отображения SQL запросов имеет **низкую критичность**
   - Это вспомогательная функция для разработчиков, не обязательная для работы системы
   - **Рекомендация:** Можно удалить вместе с legacy UI, так как SQL запросы можно получить через другие инструменты (например, через `POST /api/analysis/query` напрямую)
3. ✅ **Готовность к удалению:** Legacy Analysis UI можно безопасно удалить

### 6.3 Упоминания Legacy UI

**Найдено упоминаний:**
- Документация: 6 файлов
- Скрипты: 2 файла
- Backend код: 1 файл (main.go)
- Docker: 2 файла (Dockerfile, Makefile)
- Другие: 3 файла

**Всего:** ~14 мест, где упоминается legacy UI

### 6.4 Критерии готовности к удалению

**Перед удалением legacy UI необходимо:**
1. ✅ Подтвердить, что все функции Legacy Live UI доступны в Live UI v2 (✅ выполнено)
2. ✅ Проверить реализацию загрузки завершённых run'ов в Live UI v2 (✅ выполнено — реализовано через RunList)
3. ✅ Оценить критичность отображения SQL запросов (✅ выполнено — низкая критичность, можно удалить)
4. ✅ Обновить документацию (Этап 2) — следующий этап
5. ✅ Обновить скрипты валидации (Этап 3) — следующий этап

**Статус готовности:** ✅ **Готово к удалению** — все критичные функции реализованы в Live UI v2

---

## 7. Следующие шаги

1. ✅ **Проверка реализации загрузки завершённых run'ов в Live UI v2** — выполнено
   - ✅ Компонент `RunList` поддерживает фильтр `status: ["completed"]`
   - ✅ Поддержка фильтрации по `sourceId`, `status`, `daysBack` через `filters`
   - ✅ Отображение метаданных run'а через `showDetails={true}`

2. ✅ **Оценка критичности отображения SQL запросов** — выполнено
   - Функция имеет низкую критичность (вспомогательная для разработчиков)
   - SQL запросы можно получить через `POST /api/analysis/query` напрямую
   - **Решение:** Можно удалить вместе с legacy UI

3. **Приступить к Этапу 2:** Депрекация Legacy UI (документальная)
   - Обновить `docs/API.md`: удалить секции "Legacy UI" и "Analysis UI"
   - Обновить `docs/USER_GUIDE.md`: удалить упоминания legacy UI
   - Обновить `README.md`: убрать упоминания legacy UI
   - Обновить `DOCKER.md`: описать только Live UI v2
   - Обновить `Makefile`: изменить сообщения

---

**Статус аудита:** ✅ Завершён  
**Готовность к удалению:** ✅ **Готово** — все критичные функции реализованы в Live UI v2
