# Failure Modes and Degradation

Этот документ описывает возможные отказные сценарии teltel
и ожидаемое поведение системы в каждом из них.

teltel спроектирован так, чтобы **деградировать, а не ломаться**.

---

## Общие принципы деградации

- предпочтение потере данных блокировке
- изоляция компонентов
- отсутствие каскадных отказов
- явное поведение при перегрузке

---

## 1. Перегрузка ingest

### Сценарий

- Flight Engine или Drive Engine отправляет события быстрее,
  чем teltel успевает их обрабатывать.

### Поведение

- ingest принимает данные best‑effort
- часть событий может быть отброшена
- движок не блокируется

### Последствия

- live‑UI может пропускать кадры
- storage может получить неполные данные
- run остаётся валидным

---

## 2. Медленный подписчик EventBus

### Сценарий

- один из подписчиков (UI, storage) не успевает читать события

### Поведение

- backpressure применяется **только к этому подписчику**
- остальные подписчики продолжают работу
- политика определяется `BackpressurePolicy`

### Последствия

- возможна потеря данных у конкретного подписчика
- система остаётся работоспособной

---

## 3. Перегрузка Live UI

### Сценарий

- UI не успевает обрабатывать live‑поток
- браузер или сеть становятся узким местом

### Поведение

- UI получает только последние события
- старые события отбрасываются (drop_old)
- ingest и storage не затрагиваются

### Последствия

- визуальные пропуски
- отсутствие влияния на данные run’а

---

## 4. ClickHouse недоступен

### Сценарий

- ClickHouse не запущен
- ClickHouse временно недоступен
- ошибка записи

### Поведение

- batcher пытается писать данные
- при ошибке данные могут быть потеряны
- live‑поток продолжается

### Последствия

- run может отсутствовать в storage
- live‑наблюдение остаётся доступным
- Cursor не сможет анализировать этот run

---

## 5. Переполнение batcher’а

### Сценарий

- ClickHouse медленный
- batcher не успевает flush’ить данные

### Поведение

- batcher может блокироваться
- ingest и live‑поток продолжают работу
- возможна потеря части данных

### Последствия

- storage неполный
- run остаётся валидным для live‑анализа

---

## 6. Перезапуск teltel

### Сценарий

- сервис перезапущен
- процесс завершён аварийно

### Поведение

- in‑memory данные теряются
- незаписанные batch’и теряются
- ClickHouse данные сохраняются

### Последствия

- live‑данные потеряны
- завершённые run’ы доступны для анализа

---

## 7. Некорректные события

### Сценарий

- событие с ошибочным payload
- отсутствуют поля
- неверный формат

### Поведение

- событие может быть отброшено
- остальные события продолжают обрабатываться
- ingest не падает

### Последствия

- частичная потеря данных
- run остаётся анализируемым

---

## Поведение Cursor при отказах

Cursor:
- работает только с доступными данными
- не предполагает полноту
- учитывает возможные пропуски
- формулирует гипотезы с учётом деградации

---

## Принцип проектирования

teltel предпочитает:
> “частично полезные данные”
> вместо
> “идеально корректной, но остановленной системы”

---

## Инженерное тестирование

Failure modes, описанные в этом документе, должны быть
проверены в рамках фазы **Engineering Validation**.

Для каждого failure mode должны быть определены:
- сценарий тестирования
- ожидаемое поведение
- метрики для проверки
- критерии успеха

Детальное описание сценариев тестирования находится в
`docs/10-engineering-validation.md`.

---

## Связанные документы

- `docs/02-architecture.md`
- `docs/04-eventbus.md`
- `docs/05-ingest-and-storage.md`
- `docs/07-cursor-workflow.md`
- `docs/09-roadmap.md` — roadmap с фазой Engineering Validation
- `docs/10-engineering-validation.md` — детальные сценарии тестирования