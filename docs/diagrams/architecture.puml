# Architecture

Этот документ описывает архитектуру teltel
и взаимодействие его компонентов.

Архитектура ориентирована на:
- локальную работу
- высокочастотную телеметрию
- минимальное влияние на движки
- удобство анализа и отладки

---

## Общая схема

Источники телеметрии:
- Flight Engine
- Drive Engine

Потребители данных:
- Live Web UI
- ClickHouse (storage)
- Cursor AI (analysis)

teltel находится между ними как наблюдательный слой.

---

## Компоненты системы

### 1. HTTP Ingest

Назначение:
- принимать NDJSON события от движков
- выполнять минимальную валидацию
- передавать события во внутреннюю шину

Особенности:
- append‑only
- не парсит payload
- не блокирует источники при перегрузке

---

### 2. EventBus

EventBus — центральный компонент маршрутизации.

Назначение:
- fan‑out событий подписчикам
- фильтрация по runId, type, channel, tags
- управление backpressure

EventBus:
- работает in‑process
- не хранит данные
- не гарантирует доставку

Подробный контракт описан в `docs/04-eventbus.md`.

---

### 3. Live Buffer

Назначение:
- хранить последние события активных run’ов
- поддерживать tail + live‑stream
- обслуживать Web UI

Особенности:
- ring buffer
- данные хранятся в памяти
- оптимизирован под чтение

Live Buffer не является источником истины.

---

### 4. WebSocket API

Назначение:
- передавать события в Live Web UI
- поддерживать подписки и фильтры
- обеспечивать live‑обновления графиков

WS API:
- читает данные из Live Buffer
- не обращается напрямую к storage

---

### 5. Batcher

Назначение:
- собирать события в пачки
- управлять flush‑логикой
- писать данные в ClickHouse

Batcher:
- подписчик EventBus
- работает асинхронно
- не влияет на live‑поток

---

### 6. ClickHouse

Назначение:
- долговременное хранение телеметрии
- аналитические запросы
- сравнение run’ов

Особенности:
- данные пишутся только пачками
- формат вставки — JSONEachRow
- primary order — (run_id, frame_index)

ClickHouse не участвует в live‑потоке.

---

## Поток данных

1. Движок отправляет NDJSON события
2. HTTP Ingest принимает события
3. EventBus маршрутизирует события
4. Live Buffer обслуживает live‑UI
5. Batcher пишет данные в ClickHouse
6. UI и Cursor читают данные для анализа

---

## Разделение ответственности

| Компонент     | Ответственность |
|---------------|-----------------|
| Движки        | Генерация событий |
| Ingest        | Приём данных |
| EventBus      | Маршрутизация |
| Live Buffer   | Live‑доступ |
| Batcher       | Подготовка к storage |
| ClickHouse    | Хранение и анализ |
| UI / Cursor   | Визуализация и reasoning |

---

## Архитектурные принципы

- один процесс
- явные границы
- отсутствие скрытых зависимостей
- деградация вместо блокировки
- простота важнее универсальности

---

## Связанные документы

- `docs/01-goals-and-non-goals.md`
- `docs/03-event-model.md`
- `docs/04-eventbus.md`
- `docs/05-ingest-and-storage.md`
