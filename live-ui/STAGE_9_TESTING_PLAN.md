# План тестирования этапа 9: Финальная валидация

## Цель
Провести комплексное тестирование всех реализованных функций, особенно этапа 8 (Run Comparison), и завершить roadmap.

---

## 1. Тестирование этапа 8: Run Comparison

### 1.1 HTTP клиент для Analysis API

**Тестируемые функции:**
- [ ] `getRuns()` - получение списка run'ов
- [ ] `getRun(runId)` - получение метаданных run'а
- [ ] `getSeries(params)` - получение временного ряда
- [ ] `compareRuns(params)` - сравнение двух run'ов
- [ ] Парсинг JSONEachRow формата
- [ ] Преобразование исторических данных в Event формат

**Сценарии тестирования:**
1. Успешная загрузка списка run'ов
2. Фильтрация run'ов по sourceId, status, daysBack
3. Загрузка метаданных существующего run'а
4. Загрузка метаданных несуществующего run'а (404)
5. Загрузка временного ряда для существующего run'а
6. Загрузка временного ряда для несуществующего run'а
7. Сравнение двух существующих run'ов
8. Обработка ошибок сети
9. Обработка невалидного JSON
10. Парсинг пустого ответа

### 1.2 Data Layer для гибридного режима

**Тестируемые функции:**
- [ ] Поддержка `data_source.type: 'historical'`
- [ ] Поддержка `data_source.type: 'hybrid'`
- [ ] Загрузка исторических данных через HTTP API
- [ ] Кэширование исторических данных
- [ ] Объединение live и historical данных
- [ ] Очистка кэша

**Сценарии тестирования:**
1. Загрузка только исторических данных (historical)
2. Загрузка только live данных (event_stream)
3. Гибридный режим: объединение live и historical
4. Кэширование: повторная загрузка использует кэш
5. Обновление live данных в гибридном режиме
6. Очистка кэша при смене run'а
7. Обработка ошибок при загрузке исторических данных
8. Отсутствие обязательных фильтров (sourceId, type, jsonPath)

### 1.3 ChartSpec для сравнения run'ов

**Тестируемые функции:**
- [ ] Поддержка `run_ids[]` в data_source
- [ ] Поддержка historical и hybrid типов
- [ ] Дополнительные фильтры для historical данных

**Сценарии тестирования:**
1. ChartSpec с одним run_id (существующий)
2. ChartSpec с несколькими run_ids (существующие)
3. ChartSpec с несуществующими run_ids
4. ChartSpec с historical типом
5. ChartSpec с hybrid типом
6. ChartSpec с фильтрами (sourceId, jsonPath)
7. Валидация ChartSpec через JSON Schema

### 1.4 UI компоненты для управления run'ами

**Тестируемые функции:**
- [ ] RunSelector компонент
- [ ] RunList компонент
- [ ] Hook useRuns
- [ ] Интеграция в HeaderRegion и LeftPanelRegion

**Сценарии тестирования:**
1. Отображение списка run'ов в RunList
2. Выбор run'а в RunSelector
3. Загрузка run'ов с фильтрами
4. Обработка состояния загрузки (isLoading)
5. Обработка ошибок загрузки
6. Обновление списка run'ов (reload)
7. Интеграция в layout (header, left_panel)

### 1.5 Визуализация сравнения run'ов

**Тестируемые функции:**
- [ ] Множественные series на одном графике
- [ ] Цветовое кодирование run'ов
- [ ] Легенда с метками run'ов
- [ ] Синхронизация time_cursor для всех run'ов

**Сценарии тестирования:**
1. Отображение одного run'а на графике
2. Отображение нескольких run'ов на одном графике
3. Разные цвета для разных run'ов
4. Легенда отображает все run'ы
5. Клик по легенде скрывает/показывает run
6. Синхронизация time_cursor работает для всех run'ов
7. Zoom/pan синхронизирован для всех run'ов

### 1.6 Интеграция в существующие графики

**Тестируемые функции:**
- [ ] TimeSeriesChart поддерживает множественные run'ы
- [ ] ScatterChart поддерживает множественные run'ы
- [ ] EventTimelineChart поддерживает множественные run'ы

**Сценарии тестирования:**
1. TimeSeriesChart с одним run'ом
2. TimeSeriesChart с несколькими run'ами
3. ScatterChart с одним run'ом
4. ScatterChart с несколькими run'ами
5. EventTimelineChart с одним run'ом
6. EventTimelineChart с несколькими run'ами
7. Все типы графиков корректно отображают легенду

---

## 2. Интеграционное тестирование

### 2.1 Полный стек

**Тестируемые компоненты:**
- [ ] ClickHouse работает
- [ ] Backend (teltel) работает
- [ ] Live UI работает
- [ ] Все сервисы доступны через docker-compose

**Сценарии тестирования:**
1. Запуск полного стека через `docker-compose up`
2. Health checks всех сервисов проходят
3. WebSocket подключение устанавливается
4. Analysis API доступен
5. Загрузка layout работает
6. Все типы графиков рендерятся

### 2.2 WebSocket подключение

**Тестируемые функции:**
- [ ] Подключение к WebSocket
- [ ] Подписка на события
- [ ] Получение live данных
- [ ] Переподключение при разрыве соединения

**Сценарии тестирования:**
1. Успешное подключение
2. Получение событий через WebSocket
3. Автоматическое переподключение при разрыве
4. Обработка ошибок подключения
5. Обновление подписки работает

### 2.3 Analysis API

**Тестируемые функции:**
- [ ] Доступность API endpoints
- [ ] Корректность ответов
- [ ] Обработка ошибок

**Сценарии тестирования:**
1. GET /api/analysis/runs возвращает список
2. GET /api/analysis/run/{runId} возвращает метаданные
3. GET /api/analysis/series возвращает временной ряд
4. GET /api/analysis/compare возвращает сравнение
5. Обработка 404 для несуществующих run'ов
6. Обработка 500 для ошибок сервера

---

## 3. Тестирование производительности

### 3.1 Загрузка исторических данных

**Метрики:**
- [ ] Время загрузки для малых объёмов (< 1000 точек)
- [ ] Время загрузки для средних объёмов (1000-10000 точек)
- [ ] Время загрузки для больших объёмов (> 10000 точек)
- [ ] Использование памяти при загрузке

**Сценарии тестирования:**
1. Загрузка одного run'а с малым объёмом данных
2. Загрузка одного run'а с большим объёмом данных
3. Загрузка нескольких run'ов одновременно
4. Кэширование уменьшает время повторной загрузки

### 3.2 Рендеринг графиков

**Метрики:**
- [ ] Время рендеринга для одного run'а
- [ ] Время рендеринга для нескольких run'ов
- [ ] FPS при обновлении live данных
- [ ] Использование памяти при рендеринге

**Сценарии тестирования:**
1. Рендеринг TimeSeriesChart с одним run'ом
2. Рендеринг TimeSeriesChart с 5 run'ами
3. Рендеринг ScatterChart с несколькими run'ами
4. Обновление live данных не вызывает лагов
5. Zoom/pan работает плавно

### 3.3 Гибридный режим

**Метрики:**
- [ ] Время объединения live и historical данных
- [ ] Использование памяти в гибридном режиме
- [ ] Производительность обновлений

**Сценарии тестирования:**
1. Объединение live и historical данных работает быстро
2. Обновления live данных не замедляют рендеринг
3. Память не растёт при длительной работе

---

## 4. Тестирование обработки ошибок

### 4.1 Ошибки сети

**Сценарии:**
- [ ] Ошибка подключения к WebSocket
- [ ] Ошибка загрузки исторических данных
- [ ] Таймаут при загрузке данных
- [ ] Отсутствие интернета

### 4.2 Ошибки данных

**Сценарии:**
- [ ] Невалидный Event из WebSocket
- [ ] Невалидный JSON из Analysis API
- [ ] Отсутствие обязательных полей
- [ ] Неправильный формат данных

### 4.3 Edge cases

**Сценарии:**
- [ ] Пустой список run'ов
- [ ] Run без данных
- [ ] Run с очень большим объёмом данных
- [ ] Одновременная загрузка множества run'ов
- [ ] Быстрое переключение между run'ами

---

## 5. Тестирование обратной совместимости

### 5.1 Существующие layout'ы

**Сценарии:**
- [ ] Старые layout'ы без run_ids работают
- [ ] Старые layout'ы с event_stream работают
- [ ] Старые layout'ы без historical работают

### 5.2 Существующие функции

**Сценарии:**
- [ ] Live графики работают как раньше
- [ ] Интерактивность работает как раньше
- [ ] WebSocket подключение работает как раньше

---

## 6. Критерии успеха

### 6.1 Функциональность

- ✅ Все функции этапа 8 работают корректно
- ✅ Все типы графиков поддерживают сравнение run'ов
- ✅ Гибридный режим работает стабильно
- ✅ UI компоненты для управления run'ами работают

### 6.2 Производительность

- ✅ Загрузка исторических данных < 2 секунд для < 10000 точек
- ✅ Рендеринг графиков с несколькими run'ами плавный (60 FPS)
- ✅ Память не растёт при длительной работе

### 6.3 Надёжность

- ✅ Обработка всех типов ошибок
- ✅ Автоматическое переподключение работает
- ✅ Нет критических багов

### 6.4 Обратная совместимость

- ✅ Старые layout'ы работают
- ✅ Существующие функции не сломаны
- ✅ Нет регрессий

---

## 7. Отчёт о тестировании

После завершения тестирования будет создан отчёт с:
- Результатами всех тестов
- Найденными проблемами
- Рекомендациями по улучшению
- Метриками производительности
