# План миграции WebSocket на относительный URL

## Статус: ✅ Выполнено

Этап 5 из roadmap: nginx proxy и переход Live UI v2 на fetch API.

## Цель

Миграция WebSocket клиента на использование относительного URL `/ws` вместо абсолютных URL типа `ws://localhost:8081/ws`. Это устраняет зависимость от внешних портов и обеспечивает единый origin для браузера через nginx proxy.

## Выполненные изменения

### 1. Упрощение `src/utils/config.ts`

**Изменения:**
- ✅ `getWebSocketUrl()` уже возвращает относительный путь `/ws`
- ✅ Добавлена функция `normalizeWebSocketUrl()` для обратной совместимости (преобразует относительный путь в абсолютный URL при необходимости)
- ✅ Обновлены комментарии, объясняющие что браузер автоматически преобразует относительный путь в абсолютный URL

**Код:**
```typescript
export function getWebSocketUrl(): string {
  // Возвращаем относительный путь - браузер автоматически преобразует его
  // в абсолютный URL на основе текущего origin
  return '/ws';
}
```

### 2. Обновление `src/data/websocket.ts`

**Изменения:**
- ✅ Добавлен комментарий, объясняющий что WebSocket API автоматически преобразует относительный путь в абсолютный URL
- ✅ Код уже использует `getWebSocketUrl()`, который теперь возвращает `/ws`

**Код:**
```typescript
// WebSocket API автоматически преобразует относительный путь (например, /ws)
// в абсолютный URL на основе текущего origin (например, ws://localhost:3000/ws)
const ws = new WebSocket(this.options.url);
```

### 3. Проверка `src/data/layer.ts`

**Результат:**
- ✅ Использует `getWebSocketUrl()` корректно
- ✅ Передает относительный путь в `WSClient`
- ✅ Изменений не требуется

### 4. Упрощение `docker-entrypoint.sh`

**Изменения:**
- ✅ Убрана генерация `window.__ENV__.VITE_WS_URL` из environment variable `VITE_WS_URL`
- ✅ Оставлена только генерация `VITE_LAYOUT_URL` (опционально)
- ✅ Обновлены комментарии, объясняющие что WebSocket URL больше не требует runtime конфигурации

**До:**
```bash
# Добавляем VITE_WS_URL если установлен
if [ -n "$VITE_WS_URL" ]; then
    echo "window.__ENV__.VITE_WS_URL = '${VITE_WS_URL}';" >> "$CONFIG_JS_PATH"
fi
```

**После:**
```bash
# WebSocket URL теперь использует относительный путь /ws (настроен в коде)
# и не требует runtime конфигурации
```

### 5. Обновление `Dockerfile`

**Изменения:**
- ✅ Убраны build-time переменные `ARG VITE_WS_URL` и `ENV VITE_WS_URL`
- ✅ Убрана runtime переменная `ENV VITE_WS_URL=""`
- ✅ Оставлены только переменные для `VITE_LAYOUT_URL` (опционально)
- ✅ Добавлены комментарии, объясняющие что `VITE_WS_URL` больше не используется

**До:**
```dockerfile
ARG VITE_WS_URL
ARG VITE_LAYOUT_URL

ENV VITE_WS_URL=${VITE_WS_URL}
ENV VITE_LAYOUT_URL=${VITE_LAYOUT_URL}
```

**После:**
```dockerfile
# VITE_WS_URL больше не используется - WebSocket использует относительный путь /ws
ARG VITE_LAYOUT_URL

ENV VITE_LAYOUT_URL=${VITE_LAYOUT_URL}
```

### 6. Обновление `public/config.js`

**Изменения:**
- ✅ Убраны все упоминания `VITE_WS_URL`
- ✅ Убраны закомментированные примеры использования `VITE_WS_URL`
- ✅ Обновлены комментарии, объясняющие что WebSocket URL использует относительный путь

**До:**
```javascript
if (!window.__ENV__.VITE_WS_URL) {
  // window.__ENV__.VITE_WS_URL = 'ws://localhost:8080/ws';
}
```

**После:**
```javascript
// WebSocket URL теперь использует относительный путь /ws (настроен в коде)
// и не требует runtime конфигурации
```

## Технические детали

### Как работает относительный WebSocket URL

WebSocket API в браузере автоматически преобразует относительные пути в абсолютные URL на основе текущего origin:

1. **Относительный путь:** `/ws`
2. **Текущий origin:** `http://localhost:3000`
3. **Автоматическое преобразование:** `ws://localhost:3000/ws`

Это стандартное поведение WebSocket API, поэтому не требуется дополнительная обработка.

### Обратная совместимость

Добавлена функция `normalizeWebSocketUrl()` в `config.ts` для случаев, когда может потребоваться явное преобразование относительного пути в абсолютный URL. Однако, в текущей реализации эта функция не используется, так как WebSocket API обрабатывает это автоматически.

### Преимущества миграции

1. **Единый origin:** Браузер обращается только к `http://localhost:3000`, все запросы идут через nginx proxy
2. **Упрощение конфигурации:** Не требуется настройка `VITE_WS_URL` в docker-compose или environment variables
3. **Единообразие dev/prod:** Одинаковые относительные пути работают в обоих окружениях
4. **Устранение CORS:** Нет проблем с CORS, так как все запросы идут через один origin

## Зависимости

Эта миграция зависит от:
- ✅ Этап 1: Аудит HTTP и WebSocket обращений (завершен)
- ✅ Этап 2: Проектирование nginx proxy конфигурации (завершен)
- ⏳ Этап 3: Docker-интеграция nginx (в процессе)
- ⏳ Этап 6: Проверка dev/prod parity (ожидает завершения Этапа 3)

## Риски и меры снижения

### Риск 1: WebSocket не работает с относительными путями

**Вероятность:** Низкая  
**Влияние:** Высокое  
**Меры снижения:**
- WebSocket API в браузере поддерживает относительные пути (стандартное поведение)
- Добавлена функция `normalizeWebSocketUrl()` для обратной совместимости
- Тестирование в dev и prod окружениях

### Риск 2: Потеря обратной совместимости

**Вероятность:** Низкая  
**Влияние:** Среднее  
**Меры снижения:**
- Функция `normalizeWebSocketUrl()` поддерживает абсолютные URL (если URL начинается с `ws://` или `wss://`, используется как есть)
- Документированы изменения в конфигурации

## Тестирование

### Проверка в dev-режиме

1. Запустить `npm run dev`
2. Проверить что WebSocket подключается к `/ws` (относительный путь)
3. Проверить что данные приходят через WebSocket

### Проверка в Docker

1. Запустить `docker-compose up`
2. Проверить что WebSocket подключается через nginx proxy
3. Проверить что нет ошибок CORS
4. Проверить что данные приходят через WebSocket

### Проверка конфигурации

1. Убедиться что `VITE_WS_URL` не используется в docker-compose.yml
2. Убедиться что `config.js` не содержит `VITE_WS_URL`
3. Убедиться что WebSocket URL в коде равен `/ws`

## Следующие шаги

1. ✅ Завершить Этап 3: Docker-интеграция nginx (убрать `VITE_WS_URL` из docker-compose.yml)
2. ⏳ Завершить Этап 6: Проверка dev/prod parity (настроить Vite proxy для dev-режима)
3. ⏳ Завершить Этап 7: Документация (обновить README.md и другие документы)

## Файлы изменены

- ✅ `src/utils/config.ts` - упрощение `getWebSocketUrl()`, добавление `normalizeWebSocketUrl()`
- ✅ `src/data/websocket.ts` - обновление комментариев
- ✅ `src/data/layer.ts` - проверка (изменений не требуется)
- ✅ `docker-entrypoint.sh` - убрана генерация `VITE_WS_URL`
- ✅ `Dockerfile` - убраны build-time и runtime переменные `VITE_WS_URL`
- ✅ `public/config.js` - убраны упоминания `VITE_WS_URL`

## Дата выполнения

2024

## Версия

1.0
