services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: teltel-clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
    volumes:
      - ./data/clickhouse:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=secret
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - teltel-network

  # Backend API (без статического UI; только /api/* и /ws)
  # После настройки nginx proxy (Этап 2) backend доступен только внутри Docker сети
  # Внешний доступ к API: http://localhost:3000/api/* (через nginx proxy в live-ui)
  teltel:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: teltel
    # Убран внешний порт 8081:8080 - backend доступен только через nginx proxy
    # Внутренний адрес: http://teltel:8080 (для nginx proxy)
    # Внешний доступ: http://localhost:3000/api/* (через nginx proxy)
    # ports:
    #   - "8081:8080"
    environment:
      - TELTEL_HTTP_PORT=8080
      - TELTEL_CLICKHOUSE_URL=http://default:secret@clickhouse:8123
      - TELTEL_BATCHER_ENABLED=true
      - TELTEL_BATCHER_BATCH_SIZE=10000
      - TELTEL_BATCHER_FLUSH_INTERVAL=500ms
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - teltel-network

  # Live UI v2 — единственный пользовательский интерфейс проекта
  # nginx proxy: единая точка входа для браузера
  # - / → React Build (статический контент)
  # - /api/* → proxy_pass → http://teltel:8080/api/*
  # - /ws → proxy_pass → ws://teltel:8080/ws
  live-ui:
    build:
      context: ./live-ui
      dockerfile: Dockerfile
    container_name: teltel-live-ui
    ports:
      - "3000:80"
    # Убрана переменная VITE_WS_URL - используются относительные пути (/ws)
    # После миграции на относительные пути (Этапы 4, 5) runtime конфигурация не нужна
    # environment:
    #   - VITE_WS_URL=ws://localhost:8081/ws
    depends_on:
      teltel:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - teltel-network

  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - teltel-network
    volumes:
      - .:/app
      - ./data/clickhouse:/data/clickhouse:ro
    environment:
      - CLICKHOUSE_URL=http://clickhouse:8123
    working_dir: /app
    command: go test ./...

networks:
  teltel-network:
    driver: bridge
